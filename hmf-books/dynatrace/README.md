## Dynatrace monitoring as code

### Introduction

Provisioning, updating, monitoring and decommissioning thousands of computing endpoints like virtual machines, containers, bare metal, etc. is no longer possible with manual processes.
It needs to process as code. Dynatrace Open Source have a tool for those purposes called **Monaco CLI**:

In this project, we are using **Monaco CLI** (from Dynatrace OSS) for automating deployment of Dynatrace Monitoring Configurations to one or multiple Dynatrace environments.

**Monaco** uses JSON. Simply placing a JSON object returned by our API into the right folder structure and adding a YAML config file, enables you to use the tool to setup that configuration on a Dynatrace environment â€“ or thousands of environments.

Monaco configuration will be added to the template generated by DHP portal initializer  
Please check the directory **"your service/dynatrace"** to get more details on the configuration.

## Dynatrace setting

How to set up your microservice to use dynatrace.
We will focus on some configurations in the dynatrace directory.

### 1. Environments

Environments defined in the environments.yaml consists of environment url, and the name of the environment variable that will be used as the API token.

```
non-prod:
    - name: "54d139b9-23ee-466d-ad7a-f98e0bd8bdf4"
    - env-url: "https://np-dt.humana.com/e/54d139b9-23ee-466d-ad7a-f98e0bd8bdf4"
    - env-token-name: "TOKEN_ENV_VAR"

```

**env-url**: The url to access dynatrace cluster. It is provided by the dynatrace team  
**name**: This is part of the env-url. For example, env-url: "https://np-dt.humana.com/e/54d139b9-23ee-466d-ad7a-f98e0bd8bdf4"  
=> here the name is "54d139b9-23ee-466d-ad7a-f98e0bd8bdf4" (known as environment id)  
**env-token-name**: Provide by dynatrace team, and it will be used to deploy via pipeline  
We can configure many dynatrace environments using this yaml file. Example: non-production, production. Each environment will be known as Monaco as a project.

### 2. Configure dynatrace environment

Each environment will have 2 directories: dashboard and management-zone  
**a. Management Zone**  
Management zones will focus specific parts of your observed topology, and the sharing of relevant team-specific data while simultaneously administering on secure access control.

We can define a management zone which comprises a set of monitored entities or dimensional data in our environment, be it hosts that share a common purpose, a specific application, a staging environment or the services of a certain technology. Entities will be ready and grouped for inclusion in management zones.  
Example: we will define configure management zone as bellow:

```json
{
  "description": null,
  "dimensionalRules": [],
  "entitySelectorBasedRules": [],
  "metadata": {
    "clusterVersion": "1.224.83.20210902-162137",
    "configurationVersions": [0]
  },
  "name": "{{.name}}",
  "rules": [
    {
      "conditions": [
        {
          "comparisonInfo": {
            "caseSensitive": false,
            "negate": false,
            "operator": "BEGINS_WITH",
            "type": "STRING",
            "value": "dhp-portal"
          },
          "key": {
            "attribute": "SERVICE_NAME",
            "type": "STATIC"
          }
        }
      ],
      "enabled": true,
      "propagationTypes": [
        "SERVICE_TO_HOST_LIKE",
        "SERVICE_TO_PROCESS_GROUP_LIKE"
      ],
      "type": "SERVICE"
    }
  ]
}
```

We create a management zones which will have a rule with condition filter that all services with the name starts with "dhp-portal"

**b. Dashboard Configuration**  
Each dashboard consists of tiles and charts that can be selected, configured, and positioned to best meet your needs.
Dynatrace provides many preconfigured tiles in addition to a number of configurable tiles that you can customize to visualize the metrics that are most relevant to the people using the dashboard.
Select any dashboard tile that reports on monitored entities in your environment (hosts, processes, or services) to view the list of monitored entities.

We have basic config for dashboard

- dashboard.yaml :
  Please change the <Owner-Id> in dashboard.yaml, because the owner of the dashboard is required field.
  File path: dynatrace/preprod/dashboard/dashboard.yaml and dynatrace/prod/dashboard/dashboard.yaml

- json file : define all configurations you want to show on dashboard. You can get more info on configuration [here](https://github.com/dynatrace-oss/dynatrace-monitoring-as-code/tree/main/cmd/monaco/test-resources/integration-all-configs/project)

```json
"tiles": [
  {
   "bounds": {
    "height": 152,
    "left": 38,
    "top": 76,
    "width": 152
   },
   "configured": true,
   "entitySelector": null,
   "name": "Problems",
   "problemSelector": null,
   "tileFilter": {
    "managementZone": {
     "id": "{{.managementZoneId}}",
     "name": "{{.managementZoneName}}"
    },
    "timeframe": null
   },
   "tileType": "OPEN_PROBLEMS"
  },
  {
   "bounds": {
    "height": 38,
    "left": 456,
    "top": 38,
    "width": 304
   },
   "configured": true,
   "name": "                               ðŸš¦Health",
   "tileFilter": {
    "managementZone": null,
    "timeframe": null
   },
   "tileType": "HEADER"
  }
]
```

##2. Create dynatrace pipeline
After modifying dynatrace configuration you need to create a pipeline target to yaml file **"your-serivce/dynatrace/monitoring-as-code-pipelines.yml"** for deploying it as monitoring as code.  
Please look into this official document: [Monaco CLI documents](https://dynatrace-oss.github.io/dynatrace-monitoring-as-code/) to get more details.
